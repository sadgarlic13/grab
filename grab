#!/bin/bash

VERSION="3.0"

CONFIG_FILE="$HOME/.grabrc"
BASE_DIR="$HOME/Downloads"
LOG_FILE="$BASE_DIR/grab.log"

# ---------- Цвета ----------
RED="\033[31m"
GREEN="\033[32m"
YELLOW="\033[33m"
BLUE="\033[34m"
NC="\033[0m"

info()    { echo -e "${BLUE}[INFO]${NC} $1"; }
success() { echo -e "${GREEN}[OK]${NC} $1"; }
warn()    { echo -e "${YELLOW}[WARN]${NC} $1"; }
error()   { echo -e "${RED}[ERR]${NC} $1"; }

notify() {
  osascript -e "display notification \"$1\" with title \"grab v$VERSION\""
}

# ---------- Конфиг ----------
if [ -f "$CONFIG_FILE" ]; then
  source "$CONFIG_FILE"
fi

DEFAULT_VIDEO_QUALITY=${DEFAULT_VIDEO_QUALITY:-1080}
DEFAULT_AUDIO_BITRATE=${DEFAULT_AUDIO_BITRATE:-192}

detect_platform() {
  case "$1" in
    *youtube.com*|*youtu.be*) echo "YouTube" ;;
    *tiktok.com*) echo "TikTok" ;;
    *instagram.com*) echo "Instagram" ;;
    *threads.net*) echo "Threads" ;;
    *) echo "Other" ;;
  esac
}

update_yt_dlp() {
  info "Обновляем yt-dlp..."
  brew upgrade yt-dlp
  success "yt-dlp обновлён"
}

self_update() {
  info "Обновляем grab..."
  git -C "$(dirname "$0")" pull
  success "grab обновлён"
  exit 0
}

usage() {
  echo "grab v$VERSION"
  echo ""
  echo "grab <url> [опции]"
  echo ""
  echo "Опции:"
  echo "  -q <качество видео>"
  echo "  -a                 только аудио"
  echo "  -b <битрейт аудио>"
  echo "  -c <cookies.txt>"
  echo ""
  echo "Команды:"
  echo "  grab update        обновить grab"
  echo "  grab upgrade       обновить yt-dlp"
  exit 1
}

# ---------- Спец-команды ----------
if [ "$1" = "update" ]; then
  self_update
fi

if [ "$1" = "upgrade" ]; then
  update_yt_dlp
  exit 0
fi

if [ -z "$1" ]; then
  usage
fi

URL="$1"
shift

QUALITY=""
AUDIO_ONLY=false
AUDIO_BITRATE=""
COOKIES=""

while getopts "q:ab:c:" opt; do
  case $opt in
    q) QUALITY=$OPTARG ;;
    a) AUDIO_ONLY=true ;;
    b) AUDIO_BITRATE=$OPTARG ;;
    c) COOKIES=$OPTARG ;;
    *) usage ;;
  esac
done

QUALITY=${QUALITY:-$DEFAULT_VIDEO_QUALITY}
AUDIO_BITRATE=${AUDIO_BITRATE:-$DEFAULT_AUDIO_BITRATE}

PLATFORM=$(detect_platform "$URL")
DOWNLOAD_DIR="$BASE_DIR/$PLATFORM"
mkdir -p "$DOWNLOAD_DIR"

info "Платформа: $PLATFORM"
info "Сохраняем в: $DOWNLOAD_DIR"

echo "[$(date)] URL: $URL" >> "$LOG_FILE"

if [ "$AUDIO_ONLY" = true ]; then
  COMMAND=(
    yt-dlp
    --newline
    --progress
    -x
    --audio-format mp3
    --audio-quality "$AUDIO_BITRATE"
    -o "$DOWNLOAD_DIR/%(title)s.%(ext)s"
  )
else
  FORMAT="bestvideo[height<=${QUALITY}]+bestaudio/best"
  COMMAND=(
    yt-dlp
    --newline
    --progress
    --merge-output-format mp4
    -f "$FORMAT"
    -o "$DOWNLOAD_DIR/%(title)s.%(ext)s"
  )
fi

if [ ! -z "$COOKIES" ]; then
  COMMAND+=(--cookies "$COOKIES")
fi

notify "Начинаем загрузку"
"${COMMAND[@]}" "$URL" 2>&1 | tee -a "$LOG_FILE"

if [ $? -eq 0 ]; then
  success "Готово"
  notify "Загрузка завершена ($PLATFORM)"
else
  error "Ошибка. Проверь лог: $LOG_FILE"
  notify "Ошибка загрузки"
fi

